<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Electron + FastAPI Chat</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; }
      h1 { margin-top: 0; }
      .container { max-width: 980px; margin: 0 auto; }
      .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
      #messages { border: 1px solid #ddd; padding: 12px; height: 420px; overflow-y: auto; }
      .msg { margin: 8px 0; padding: 8px 10px; border-radius: 8px; }
      .user { background: #eef; }
      .assistant { background: #efe; }
      textarea { width: 100%; height: 80px; }
      button { padding: 8px 12px; }
      input[type="text"] { padding: 6px 8px; width: 260px; }
      label { font-size: 14px; }
      .status { font-size: 12px; color: #666; }
      .spacer { flex: 1; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Electron + FastAPI Chat</h1>
      <div class="status">Backend: http://127.0.0.1:8000/chat</div>

      <div class="row">
        <label><input type="checkbox" id="useOllama" /> Use Ollama</label>
        <input type="text" id="model" placeholder="Model (e.g., chatgpt-oss:20b)" />
        <div class="spacer"></div>
        <button id="healthBtn">Check Health</button>
      </div>

      <div id="messages"></div>

      <div class="row">
        <textarea id="input" placeholder="Type your message..."></textarea>
      </div>
      <div class="row">
        <button id="sendBtn">Send (Ctrl+Enter)</button>
        <button id="clearBtn">Clear</button>
      </div>
    </div>

    <script>
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('sendBtn');
      const clearBtn = document.getElementById('clearBtn');
      const healthBtn = document.getElementById('healthBtn');
      const useOllamaEl = document.getElementById('useOllama');
      const modelEl = document.getElementById('model');

      const CHAT_URL = "http://127.0.0.1:8000/chat";
      const HEALTH_URL = "http://127.0.0.1:8000/health";

      function appendMessage(sender, text, cssClass) {
        const div = document.createElement('div');
        div.className = `msg ${cssClass}`;
        div.textContent = `${sender}: ${text}`;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendMessage() {
        const msg = inputEl.value.trim();
        if (!msg) return;
        appendMessage('You', msg, 'user');
        inputEl.value = '';

        try {
          const body = {
            message: msg,
            use_ollama: !!useOllamaEl.checked,
            model: modelEl.value.trim() || undefined
          };
          const resp = await fetch(CHAT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (!resp.ok) {
            const text = await resp.text();
            appendMessage('Assistant', `Error ${resp.status}: ${text}`, 'assistant');
            return;
          }
          const data = await resp.json();
          appendMessage('Assistant', data.response ?? '[No reply]', 'assistant');
        } catch (err) {
          appendMessage('Assistant', `Request failed: ${err}`, 'assistant');
        }
      }

      async function checkHealth() {
        try {
          const resp = await fetch(HEALTH_URL);
          const data = await resp.json();
          appendMessage('System', JSON.stringify(data), 'assistant');
        } catch (e) {
          appendMessage('System', `Health check failed: ${e}`, 'assistant');
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      clearBtn.addEventListener('click', () => { messagesEl.innerHTML = ''; });
      healthBtn.addEventListener('click', checkHealth);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) sendMessage();
      });
    </script>
  </body>
</html>
